"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_apigateway_1 = require("@aws-cdk/aws-apigateway");
const aws_certificatemanager_1 = require("@aws-cdk/aws-certificatemanager");
const aws_ec2_1 = require("@aws-cdk/aws-ec2");
const aws_elasticloadbalancingv2_1 = require("@aws-cdk/aws-elasticloadbalancingv2");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const aws_route53_1 = require("@aws-cdk/aws-route53");
const aws_route53_targets_1 = require("@aws-cdk/aws-route53-targets");
const core_1 = require("@aws-cdk/core");
const custom_resources_1 = require("@aws-cdk/custom-resources");
class InternalRestApi extends core_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.stack = core_1.Stack.of(this);
        this.internalCertificate = props.certificate || new aws_certificatemanager_1.DnsValidatedCertificate(this, 'Certificate', {
            hostedZone: props.hostedZone,
            domainName: props.domainName,
        });
        this.vpce = new aws_ec2_1.InterfaceVpcEndpoint(this, 'APIGWEndpoint', { privateDnsEnabled: false, service: aws_ec2_1.InterfaceVpcEndpointAwsService.APIGATEWAY, vpc: props.vpc });
        this.api = new aws_apigateway_1.RestApi(this, 'Resource', Object.assign(Object.assign({}, props.apiProps), { endpointTypes: [aws_apigateway_1.EndpointType.PRIVATE], domainName: {
                endpointType: aws_apigateway_1.EndpointType.REGIONAL,
                domainName: props.domainName,
                certificate: this.internalCertificate,
            }, policy: new aws_iam_1.PolicyDocument({
                statements: [
                    new aws_iam_1.PolicyStatement({
                        principals: [new aws_iam_1.AnyPrincipal()],
                        actions: ['execute-api:Invoke'],
                        resources: [`arn:aws:execute-api:${core_1.Aws.REGION}:${core_1.Aws.ACCOUNT_ID}:*`],
                    }),
                    new aws_iam_1.PolicyStatement({
                        effect: aws_iam_1.Effect.DENY,
                        principals: [new aws_iam_1.AnyPrincipal()],
                        actions: ['execute-api:Invoke'],
                        resources: [`arn:aws:execute-api:${core_1.Aws.REGION}:${core_1.Aws.ACCOUNT_ID}:*`],
                        conditions: { StringNotEquals: { 'aws:SourceVpce': this.vpce.vpcEndpointId } },
                    }),
                ],
            }) }));
        this.restApiId = this.api.restApiId;
        this.alb = new aws_elasticloadbalancingv2_1.ApplicationLoadBalancer(this, 'InternalALB', { vpc: props.vpc, securityGroup: props.securityGroup });
        this.vpce.connections.allowFrom(this.alb, aws_ec2_1.Port.tcp(443));
        const targetGroup = new aws_elasticloadbalancingv2_1.ApplicationTargetGroup(this, 'TargetGroup', {
            vpc: props.vpc,
            targetType: aws_elasticloadbalancingv2_1.TargetType.IP,
            port: 443,
        });
        for (let index = 0; index < props.vpc.availabilityZones.length; index++) {
            const getEndpointIp = new custom_resources_1.AwsCustomResource(this, `GetEndpointIp${index}`, {
                onUpdate: {
                    service: 'EC2',
                    action: 'describeNetworkInterfaces',
                    outputPath: `NetworkInterfaces.${index}.PrivateIpAddress`,
                    parameters: { NetworkInterfaceIds: this.vpce.vpcEndpointNetworkInterfaceIds },
                    physicalResourceIdPath: `NetworkInterfaces.${index}.PrivateIpAddress`,
                },
            });
            targetGroup.addTarget(new aws_elasticloadbalancingv2_1.IpTarget(core_1.Token.asString(getEndpointIp.getData(`NetworkInterfaces.${index}.PrivateIpAddress`))));
        }
        this.alb.addListener('Listener', {
            certificateArns: [this.internalCertificate.certificateArn],
            port: 443,
            defaultTargetGroups: [targetGroup],
        });
        targetGroup.configureHealthCheck({
            healthyHttpCodes: '403',
            healthyThresholdCount: 2,
            unhealthyThresholdCount: 2,
            interval: core_1.Duration.seconds(30),
            timeout: core_1.Duration.seconds(5),
            path: '/',
            protocol: aws_elasticloadbalancingv2_1.Protocol.HTTPS,
        });
        new aws_route53_1.ARecord(this, 'R53Alias', {
            recordName: props.domainName,
            zone: props.hostedZone,
            target: aws_route53_1.RecordTarget.fromAlias(new aws_route53_targets_1.LoadBalancerTarget(this.alb)),
        });
    }
}
exports.InternalRestApi = InternalRestApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwtcmVzdC1hcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbnRlcm5hbC1yZXN0LWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDREQUF3RjtBQUN4Riw0RUFBd0Y7QUFDeEYsOENBQW9IO0FBQ3BILG9GQUFzSTtBQUN0SSw4Q0FBeUY7QUFDekYsc0RBQTBFO0FBQzFFLHNFQUFrRTtBQUNsRSx3Q0FBdUU7QUFDdkUsZ0VBQThEO0FBc0M5RCxNQUFhLGVBQWdCLFNBQVEsZ0JBQVM7SUFzQjFDLFlBQVksS0FBaUIsRUFBRSxFQUFXLEVBQUUsS0FBNEI7UUFDcEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLFlBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFNUIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEtBQUssQ0FBQyxXQUFXLElBQUksSUFBSSxnREFBdUIsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQzdGLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtZQUM1QixVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7U0FDL0IsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLDhCQUFvQixDQUFDLElBQUksRUFBRSxlQUFlLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLHdDQUE4QixDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFFOUosSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLHdCQUFPLENBQUMsSUFBSSxFQUFFLFVBQVUsa0NBQ2hDLEtBQUssQ0FBQyxRQUFRLEtBQ2pCLGFBQWEsRUFBRSxDQUFDLDZCQUFZLENBQUMsT0FBTyxDQUFDLEVBQ3JDLFVBQVUsRUFBRTtnQkFDUixZQUFZLEVBQUUsNkJBQVksQ0FBQyxRQUFRO2dC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LENBQUM7WUFDN0IsZ0JBQWdCLEVBQUUsS0FBSztZQUN2QixxQkFBcUIsRUFBRSxDQUFDO1lBQ3hCLHVCQUF1QixFQUFFLENBQUM7WUFDMUIsUUFBUSxFQUFFLGVBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQzlCLE9BQU8sRUFBRSxlQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUM1QixJQUFJLEVBQUUsR0FBRztZQUNULFFBQVEsRUFBRSxxQ0FBUSxDQUFDLEtBQUs7U0FDM0IsQ0FBQyxDQUFDO1FBRUgsSUFBSSxxQkFBTyxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUU7WUFDMUIsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO1lBQzVCLElBQUksRUFBRSxLQUFLLENBQUMsVUFBVTtZQUN0QixNQUFNLEVBQUUsMEJBQVksQ0FBQyxTQUFTLENBQUMsSUFBSSx3Q0FBa0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDbkUsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBdkdELDBDQXVHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVuZHBvaW50VHlwZSwgSVJlc3RBcGksIFJlc3RBcGksIFJlc3RBcGlQcm9wcyB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCB7IERuc1ZhbGlkYXRlZENlcnRpZmljYXRlLCBJQ2VydGlmaWNhdGUgfSBmcm9tICdAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyJztcbmltcG9ydCB7IEludGVyZmFjZVZwY0VuZHBvaW50LCBJbnRlcmZhY2VWcGNFbmRwb2ludEF3c1NlcnZpY2UsIElTZWN1cml0eUdyb3VwLCBJVnBjLCBQb3J0IH0gZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbkxvYWRCYWxhbmNlciwgQXBwbGljYXRpb25UYXJnZXRHcm91cCwgSXBUYXJnZXQsIFByb3RvY29sLCBUYXJnZXRUeXBlIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWVsYXN0aWNsb2FkYmFsYW5jaW5ndjInO1xuaW1wb3J0IHsgQW55UHJpbmNpcGFsLCBFZmZlY3QsIFBvbGljeURvY3VtZW50LCBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdAYXdzLWNkay9hd3MtaWFtJztcbmltcG9ydCB7IEFSZWNvcmQsIElIb3N0ZWRab25lLCBSZWNvcmRUYXJnZXQgfSBmcm9tICdAYXdzLWNkay9hd3Mtcm91dGU1Myc7XG5pbXBvcnQgeyBMb2FkQmFsYW5jZXJUYXJnZXQgfSBmcm9tICdAYXdzLWNkay9hd3Mtcm91dGU1My10YXJnZXRzJztcbmltcG9ydCB7IEF3cywgQ29uc3RydWN0LCBEdXJhdGlvbiwgU3RhY2ssIFRva2VuIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgeyBBd3NDdXN0b21SZXNvdXJjZSB9IGZyb20gJ0Bhd3MtY2RrL2N1c3RvbS1yZXNvdXJjZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEludGVybmFsUmVzdEFwaVByb3BzIHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBkb21haW4gbmFtZSB0byB1c2UgZm9yIHRoZSBpbnRlcm5hbCBBUElcbiAgICAgKi9cbiAgICByZWFkb25seSBkb21haW5OYW1lIDogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBSb3V0ZTUzIEhvc3RlZFpvbmUgdG8gYWRkIHRoZSBkb21haW4gdG8uXG4gICAgICogVGhpcyBpcyB1c2VkIGZvciBBQ00gRE5TIHZhbGlkYXRpb24gdG9vLCBpZiBubyBjZXJ0aWZpY2F0ZSBpcyBwcm92aWRlZC5cbiAgICAgKi9cbiAgICByZWFkb25seSBob3N0ZWRab25lIDogSUhvc3RlZFpvbmU7XG4gICAgLyoqXG4gICAgICogVGhlIFZQQyB0byBkZXBsb3kgdGhlIGludGVybmFsIEFMQiBpbnRvXG4gICAgICovXG4gICAgcmVhZG9ubHkgdnBjIDogSVZwYztcblxuICAgIC8qKlxuICAgICAqIEFQSSBwcm9wZXJ0aWVzIGZvciB0aGUgdW5kZXJseWluZyBSZXN0QXBpIGNvbnN0cnVjdFxuICAgICAqXG4gICAgICogQGRlZmF1bHQgLSBOb25lXG4gICAgICovXG4gICAgcmVhZG9ubHkgYXBpUHJvcHM/IDogUmVzdEFwaVByb3BzO1xuICAgIC8qKlxuICAgICAqIFRoZSBjZXJ0aWZpY2F0ZSB0byB1c2UgZm9yIHRoZSBBTEIgbGlzdGVuZXJcbiAgICAgKlxuICAgICAqIEBkZWZhdWx0IC0gVXNlIEFDTSB0byBjcmVhdGUgYSBETlMgdmFsaWRhdGVkIGNlcnRpZmljYXRlIGZvciB0aGUgZ2l2ZW4gZG9tYWluIG5hbWVcbiAgICAgKi9cbiAgICByZWFkb25seSBjZXJ0aWZpY2F0ZT8gOiBJQ2VydGlmaWNhdGU7XG4gICAgLyoqXG4gICAgICogU2VjdXJpdHkgZ3JvdXAgdG8gYXNzb2NpYXRlIHdpdGggdGhlIGludGVybmFsIGxvYWQgYmFsYW5jZXJcbiAgICAgKlxuICAgICAqIEBkZWZhdWx0IC0gQSBzZWN1cml0eSBncm91cCBpcyBjcmVhdGVkXG4gICAgICovXG4gICAgcmVhZG9ubHkgc2VjdXJpdHlHcm91cD8gOiBJU2VjdXJpdHlHcm91cDtcbn1cblxuZXhwb3J0IGNsYXNzIEludGVybmFsUmVzdEFwaSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIElSZXN0QXBpIHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBJRCBvZiB0aGlzIEFQSSBHYXRld2F5IFJlc3RBcGkuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHJlc3RBcGlJZCA6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBUaGUgc3RhY2sgaW4gd2hpY2ggdGhpcyByZXNvdXJjZSBpcyBkZWZpbmVkLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBzdGFjayA6IFN0YWNrO1xuICAgIC8qKlxuICAgICAqIFRoZSB1bmRlcmx5aW5nIFJlc3RBcGlcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgYXBpIDogUmVzdEFwaTtcbiAgICAvKipcbiAgICAgKiBUaGUgdW5kZXJseWluZyBpbnRlcm5hbCBhcHBsaWNhdGlvbiBsb2FkIGJhbGFuY2VyXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGFsYiA6IEFwcGxpY2F0aW9uTG9hZEJhbGFuY2VyO1xuXG4gICAgcHJpdmF0ZSBpbnRlcm5hbENlcnRpZmljYXRlIDogSUNlcnRpZmljYXRlO1xuICAgIHByaXZhdGUgdnBjZSA6IEludGVyZmFjZVZwY0VuZHBvaW50O1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGUgOiBDb25zdHJ1Y3QsIGlkIDogc3RyaW5nLCBwcm9wcyA6IEludGVybmFsUmVzdEFwaVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgICAgIHRoaXMuc3RhY2sgPSBTdGFjay5vZih0aGlzKTtcblxuICAgICAgICB0aGlzLmludGVybmFsQ2VydGlmaWNhdGUgPSBwcm9wcy5jZXJ0aWZpY2F0ZSB8fCBuZXcgRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUodGhpcywgJ0NlcnRpZmljYXRlJywge1xuICAgICAgICAgICAgaG9zdGVkWm9uZTogcHJvcHMuaG9zdGVkWm9uZSxcbiAgICAgICAgICAgIGRvbWFpbk5hbWU6IHByb3BzLmRvbWFpbk5hbWUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudnBjZSA9IG5ldyBJbnRlcmZhY2VWcGNFbmRwb2ludCh0aGlzLCAnQVBJR1dFbmRwb2ludCcsIHsgcHJpdmF0ZURuc0VuYWJsZWQ6IGZhbHNlLCBzZXJ2aWNlOiBJbnRlcmZhY2VWcGNFbmRwb2ludEF3c1NlcnZpY2UuQVBJR0FURVdBWSwgdnBjOiBwcm9wcy52cGMgfSk7XG5cbiAgICAgICAgdGhpcy5hcGkgPSBuZXcgUmVzdEFwaSh0aGlzLCAnUmVzb3VyY2UnLCB7XG4gICAgICAgICAgICAuLi5wcm9wcy5hcGlQcm9wcyxcbiAgICAgICAgICAgIGVuZHBvaW50VHlwZXM6IFtFbmRwb2ludFR5cGUuUFJJVkFURV0sXG4gICAgICAgICAgICBkb21haW5OYW1lOiB7XG4gICAgICAgICAgICAgICAgZW5kcG9pbnRUeXBlOiBFbmRwb2ludFR5cGUuUkVHSU9OQUwsXG4gICAgICAgICAgICAgICAgZG9tYWluTmFtZTogcHJvcHMuZG9tYWluTmFtZSxcbiAgICAgICAgICAgICAgICBjZXJ0aWZpY2F0ZTogdGhpcy5pbnRlcm5hbENlcnRpZmljYXRlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBvbGljeTogbmV3IFBvbGljeURvY3VtZW50KHtcbiAgICAgICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgICAgIG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBBbnlQcmluY2lwYWwoKV0sXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbJ2V4ZWN1dGUtYXBpOkludm9rZSddLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHtBd3MuUkVHSU9OfToke0F3cy5BQ0NPVU5UX0lEfToqYF0sXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkRFTlksXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmluY2lwYWxzOiBbbmV3IEFueVByaW5jaXBhbCgpXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnZXhlY3V0ZS1hcGk6SW52b2tlJ10sXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgYXJuOmF3czpleGVjdXRlLWFwaToke0F3cy5SRUdJT059OiR7QXdzLkFDQ09VTlRfSUR9OipgXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbnM6IHsgU3RyaW5nTm90RXF1YWxzOiB7ICdhd3M6U291cmNlVnBjZSc6IHRoaXMudnBjZS52cGNFbmRwb2ludElkIH0gfSxcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZXN0QXBpSWQgPSB0aGlzLmFwaS5yZXN0QXBpSWQ7XG5cbiAgICAgICAgdGhpcy5hbGIgPSBuZXcgQXBwbGljYXRpb25Mb2FkQmFsYW5jZXIodGhpcywgJ0ludGVybmFsQUxCJywgeyB2cGM6IHByb3BzLnZwYywgc2VjdXJpdHlHcm91cDogcHJvcHMuc2VjdXJpdHlHcm91cCB9KTtcbiAgICAgICAgdGhpcy52cGNlLmNvbm5lY3Rpb25zLmFsbG93RnJvbSh0aGlzLmFsYiwgUG9ydC50Y3AoNDQzKSk7XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0R3JvdXAgPSBuZXcgQXBwbGljYXRpb25UYXJnZXRHcm91cCh0aGlzLCAnVGFyZ2V0R3JvdXAnLCB7XG4gICAgICAgICAgICB2cGM6IHByb3BzLnZwYyxcbiAgICAgICAgICAgIHRhcmdldFR5cGU6IFRhcmdldFR5cGUuSVAsXG4gICAgICAgICAgICBwb3J0OiA0NDMsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBwcm9wcy52cGMuYXZhaWxhYmlsaXR5Wm9uZXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBnZXRFbmRwb2ludElwID0gbmV3IEF3c0N1c3RvbVJlc291cmNlKHRoaXMsIGBHZXRFbmRwb2ludElwJHtpbmRleH1gLCB7XG4gICAgICAgICAgICAgICAgb25VcGRhdGU6IHtcbiAgICAgICAgICAgICAgICAgICAgc2VydmljZTogJ0VDMicsXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2Rlc2NyaWJlTmV0d29ya0ludGVyZmFjZXMnLFxuICAgICAgICAgICAgICAgICAgICBvdXRwdXRQYXRoOiBgTmV0d29ya0ludGVyZmFjZXMuJHtpbmRleH0uUHJpdmF0ZUlwQWRkcmVzc2AsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IHsgTmV0d29ya0ludGVyZmFjZUlkczogdGhpcy52cGNlLnZwY0VuZHBvaW50TmV0d29ya0ludGVyZmFjZUlkcyB9LFxuICAgICAgICAgICAgICAgICAgICBwaHlzaWNhbFJlc291cmNlSWRQYXRoOiBgTmV0d29ya0ludGVyZmFjZXMuJHtpbmRleH0uUHJpdmF0ZUlwQWRkcmVzc2AsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGFyZ2V0R3JvdXAuYWRkVGFyZ2V0KG5ldyBJcFRhcmdldChUb2tlbi5hc1N0cmluZyhnZXRFbmRwb2ludElwLmdldERhdGEoYE5ldHdvcmtJbnRlcmZhY2VzLiR7aW5kZXh9LlByaXZhdGVJcEFkZHJlc3NgKSkpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYWxiLmFkZExpc3RlbmVyKCdMaXN0ZW5lcicsIHtcbiAgICAgICAgICAgIGNlcnRpZmljYXRlQXJuczogW3RoaXMuaW50ZXJuYWxDZXJ0aWZpY2F0ZS5jZXJ0aWZpY2F0ZUFybl0sXG4gICAgICAgICAgICBwb3J0OiA0NDMsXG4gICAgICAgICAgICBkZWZhdWx0VGFyZ2V0R3JvdXBzOiBbdGFyZ2V0R3JvdXBdLFxuICAgICAgICB9KTtcbiAgICAgICAgdGFyZ2V0R3JvdXAuY29uZmlndXJlSGVhbHRoQ2hlY2soe1xuICAgICAgICAgICAgaGVhbHRoeUh0dHBDb2RlczogJzQwMycsXG4gICAgICAgICAgICBoZWFsdGh5VGhyZXNob2xkQ291bnQ6IDIsXG4gICAgICAgICAgICB1bmhlYWx0aHlUaHJlc2hvbGRDb3VudDogMixcbiAgICAgICAgICAgIGludGVydmFsOiBEdXJhdGlvbi5zZWNvbmRzKDMwKSxcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoNSksXG4gICAgICAgICAgICBwYXRoOiAnLycsXG4gICAgICAgICAgICBwcm90b2NvbDogUHJvdG9jb2wuSFRUUFMsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5ldyBBUmVjb3JkKHRoaXMsICdSNTNBbGlhcycsIHtcbiAgICAgICAgICAgIHJlY29yZE5hbWU6IHByb3BzLmRvbWFpbk5hbWUsXG4gICAgICAgICAgICB6b25lOiBwcm9wcy5ob3N0ZWRab25lLFxuICAgICAgICAgICAgdGFyZ2V0OiBSZWNvcmRUYXJnZXQuZnJvbUFsaWFzKG5ldyBMb2FkQmFsYW5jZXJUYXJnZXQodGhpcy5hbGIpKSxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19